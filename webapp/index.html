<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>FRUTA Telemetry Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <style>
    :root{
      --bg:#f3f6fb; --card:#fff; --muted:#6b7280; --accent:#0ea5a4; --accent-600:#089189;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:14px}
    header h1{margin:0;font-size:20px}
    header p{margin:0;color:var(--muted);font-size:13px}
    .controls-row{display:flex;gap:10px;align-items:center}
    .card{background:var(--card);border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,0.06);padding:14px}
    .top-grid{display:grid;grid-template-columns: 1fr 380px; gap:14px}
    .viewer{min-height:360px;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    .viewer .imgwrap{flex:1;background:linear-gradient(180deg,#eef6f9,#fff);display:flex;align-items:center;justify-content:center;border-radius:8px;padding:12px}
    .viewer img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px;box-shadow:0 6px 16px rgba(15,23,42,0.06)}
    .side-list{height:360px;overflow:auto;padding:10px;border-radius:8px;border:1px solid #eef4f6;background:#fbfcfd}
    .list-item{padding:10px;border-radius:8px;border-bottom:1px dashed #eef2f3;cursor:pointer}
    .list-item:last-child{border-bottom:0}
    .list-item:hover{background:#f0fbfa}
    .time{font-size:12px;color:var(--muted)}
    .badge{padding:4px 8px;background:var(--accent);color:#fff;border-radius:999px;font-weight:700;font-size:12px;margin-left:8px}
    .chart-area{margin-top:16px;padding:14px;border-radius:10px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    input,select{padding:8px 10px;border-radius:8px;border:1px solid #e6e9ef}
    button{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    @media(max-width:980px){
      .top-grid{grid-template-columns:1fr}
      .side-list{height:auto}
      .viewer{min-height:260px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>FRUTA Telemetry Viewer</h1>
        <p class="muted">Latest photo, detections and telemetry — click a row to load that image.</p>
      </div>
      <div class="controls-row">
        <input id="containerUrl" type="url" placeholder="https://account.blob.core.windows.net/container?sv=..." style="width:420px"/>
        <input id="sas" type="text" placeholder="?sv=... (optional if included in URL)" style="width:360px"/>
        <button id="go">Load latest</button>
      </div>
    </header>

    <div class="card">
      <div class="top-grid">
        <div class="viewer">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <div class="muted">Most recent photo / video</div>
            <div style="display:flex;gap:8px;align-items:center">
              <div id="detectionBadge" class="badge" style="display:none">MANGO</div>
              <div id="photoInfo" class="muted"></div>
            </div>
          </div>
          <div class="imgwrap" id="imgwrap">
            <div class="muted">No image loaded</div>
          </div>
        </div>

        <div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div class="muted">Timestamps & messages</div>
            <div><button id="analyzeSelected" disabled>Analyze (vision)</button></div>
          </div>
          <div class="side-list" id="list"></div>
        </div>
      </div>

      <div class="chart-area">
        <canvas id="trendChart" height="140"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    // reuse your existing functions but adapted for the new layout
    async function listBlobs(account, container, sas, containerUrl){
      let url;
      if(containerUrl){
        try { const u = new URL(containerUrl);
          if(!u.searchParams.has('restype') && !u.search.includes('comp=list')) u.search += (u.search ? '&' : '?') + 'restype=container&comp=list';
          url = u.toString();
        } catch(e){ throw new Error('Invalid container URL'); }
      } else {
        url = `https://${account}.blob.core.windows.net/${container}?restype=container&comp=list${sas ? sas : ''}`;
      }
      const res = await fetch(url);
      if(!res.ok) throw new Error('List failed: '+res.status);
      const text = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(text, "application/xml");
      const names = Array.from(doc.querySelectorAll("Name")).map(n=>n.textContent);
      const dates = Array.from(doc.querySelectorAll("Last-Modified")).map(n=>n.textContent);
      return names.map((name,i)=>({name, lastModified: dates[i]})).sort((a,b)=> new Date(b.lastModified) - new Date(a.lastModified));
    }

    async function fetchBlobText(account, container, name, sas, containerUrl){
      let url;
      if(containerUrl){
        const u = new URL(containerUrl);
        url = `${u.origin}/${u.pathname.replace(/^\/+|\/+$/g,'')}/${encodeURIComponent(name)}${u.search || sas || ''}`;
      } else {
        url = `https://${account}.blob.core.windows.net/${container}/${encodeURIComponent(name)}${sas || ''}`;
      }
      const res = await fetch(url);
      if(!res.ok) throw new Error('Fetch blob failed: '+res.status);
      return await res.text();
    }

    function decodeEnvelopeLine(line){
      try {
        const env = JSON.parse(line);
        if(env.Body){
          try { const decoded = atob(env.Body); return JSON.parse(decoded); } catch(e){ return { rawBody: env.Body }; }
        }
        return env;
      } catch(e){ return null; }
    }

    // UI helpers
    const accountEl = { account: 'frutablob', container: 'fruta-container2' }; // fallback values
    document.getElementById('go').addEventListener('click', loadLatest);
    let currentItems = [], selectedIndex = -1;

    async function loadLatest(){
      const containerUrl = document.getElementById('containerUrl').value.trim() || null;
      const sas = document.getElementById('sas').value.trim();
      setStatus('Listing blobs...', true);
      try {
        const items = await listBlobs(accountEl.account, accountEl.container, sas, containerUrl);
        currentItems = items;
        renderList(items);
        if(items.length) {
          await loadItem(0);
        } else {
          setStatus('No blobs found', false);
        }
      } catch(e){ setStatus('Error: ' + e.message, false); }
    }

    function renderList(items){
      const list = document.getElementById('list'); list.innerHTML='';
      items.forEach((it, idx)=>{
        const div = document.createElement('div'); div.className='list-item';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>${it.name}</strong><div class="time">${it.lastModified || ''}</div></div>
            <div class="muted">#${idx+1}</div>
          </div>`;
        div.onclick = ()=> loadItem(idx);
        list.appendChild(div);
      });
    }

    async function loadItem(idx){
      selectedIndex = idx;
      const it = currentItems[idx];
      document.getElementById('analyzeSelected').disabled = false;
      setStatus('Loading blob: '+it.name, true);
      const containerUrl = document.getElementById('containerUrl').value.trim() || null;
      const sas = document.getElementById('sas').value.trim();
      try {
        const text = await fetchBlobText(accountEl.account, accountEl.container, it.name, sas, containerUrl);
        setStatus('Parsing blob', false);
        const lines = text.split(/\r?\n/).filter(l=>l.trim());
        const payloads = lines.map(l=>decodeEnvelopeLine(l)).filter(Boolean);
        // pick latest payload that contains image
        let chosen = payloads.find(p=>p.imageFileName||p.blobUrl) || payloads[0] || {};
        renderViewer(chosen, accountEl.account, accountEl.container, sas, containerUrl);
        updateChart(payloads);
      } catch(e){ setStatus('Error: '+e.message, false); }
    }

    function renderViewer(payload, account, container, sas, containerUrl){
      const imgwrap = document.getElementById('imgwrap'); imgwrap.innerHTML='';
      const info = document.getElementById('photoInfo'); info.textContent='';
      const badge = document.getElementById('detectionBadge'); badge.style.display='none';

      let imgUrl = null;
      if(payload && payload.blobUrl) imgUrl = payload.blobUrl;
      else if(payload && payload.imageFileName){
        if(containerUrl){ const u = new URL(containerUrl); imgUrl = `${u.origin}/${u.pathname.replace(/^\/+|\/+$/g,'')}/${payload.imageFileName}${u.search || ''}`; }
        else imgUrl = `https://${account}.blob.core.windows.net/${container}/${encodeURIComponent(payload.imageFileName)}${sas||''}`;
      }

      if(imgUrl){
        const img = document.createElement('img'); img.src = imgUrl; img.alt='photo';
        imgwrap.appendChild(img);
        if(payload.timestamp) info.textContent = payload.timestamp;
        if(payload.mangoLikelihood || payload.prediction || payload.score){
          badge.style.display='inline-block';
          // small heuristic: show badge if mangoLikelihood > 0.5 or prediction contains 'mango'
          const score = payload.mangoLikelihood || payload.score || (payload.prediction && payload.prediction.mango) || 0;
          badge.textContent = typeof score === 'number' ? `MANGO ${(score*100|0)}%` : 'MANGO';
        }
      } else {
        imgwrap.innerHTML = '<div class="muted">No image in this payload</div>';
      }

      // show JSON preview under image if you want
      const pre = document.createElement('pre'); pre.style.marginTop='8px';
      pre.textContent = JSON.stringify(payload, null, 2);
      imgwrap.appendChild(pre);
    }

    function setStatus(msg, busy){
      // minimal status via title bar (keeps UI simple)
      document.title = busy ? `⏳ ${msg}` : `FRUTA Telemetry Viewer`;
      const badge = document.getElementById('photoInfo'); if(!busy) badge.title = '';
    }

    // simple chart: count of mango detections over the payload lines (by minute)
    let chart = null;
    function updateChart(payloads){
      const labels = [];
      const data = [];
      // aggregate by minute
      const map = {};
      payloads.forEach(p=>{
        const t = p.timestamp || p.time || p.eventTime || new Date().toISOString();
        const minute = (new Date(t)).toISOString().slice(0,16).replace('T',' ');
        const score = p.mangoLikelihood || (p.prediction && (p.prediction.mango || p.prediction['Mango'])) || 0;
        map[minute] = map[minute] || {count:0,scoreSum:0};
        map[minute].count += (score && score>0.3) ? 1 : 0;
        map[minute].scoreSum += (typeof score === 'number') ? score : 0;
      });
      Object.keys(map).sort().forEach(k=>{
        labels.push(k); data.push(map[k].count);
      });

      const ctx = document.getElementById('trendChart').getContext('2d');
      if(chart) { chart.data.labels = labels; chart.data.datasets[0].data = data; chart.update(); return; }
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Mango detections (per minute)', data, backgroundColor: '#0ea5a4' }]},
        options: { responsive:true, plugins:{legend:{display:false}}, scales:{x:{ticks:{maxRotation:0}}, y:{beginAtZero:true}} }
      });
    }

    // analyzeSelected button (calls your backend /api/analyze if present)
    document.getElementById('analyzeSelected').addEventListener('click', async ()=>{
      if(selectedIndex < 0) return;
      const it = currentItems[selectedIndex];
      try {
        const resp = await fetch('/api/analyze', {
          method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ blobName: it.name })
        });
        const j = await resp.json();
        alert('Analyze result: ' + JSON.stringify(j.prediction || j, null, 2));
      } catch(e){ alert('Analyze failed: '+e.message); }
    });

    // ready: nothing loaded until user clicks
  </script>
</body>
</html>